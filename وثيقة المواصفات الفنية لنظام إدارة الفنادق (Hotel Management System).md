> **وثيقة المواصفات الفنية لنظام إدارة الفنادق (HMS)**
> الإصدار: 1.0
> تاريخ التحديث: 06 فبراير 2026
> الحالة: نهائي

# وثيقة المواصفات الفنية لنظام إدارة الفنادق (Hotel Management System)

## 1. مقدمة تنفيذية

هذا المستند يقدم المواصفات الفنية والهندسية الكاملة لتصميم، تطوير، ونشر نظام إدارة الفنادق (HMS)، وهو عبارة عن منصة برمجيات كخدمة (SaaS) متعددة المستأجرين. تم إعداد هذه الوثيقة لتكون المرجع الأساسي والوحيد (Single Source of Truth) لجميع الفرق المعنية بالمشروع، بما في ذلك فرق الهندسة، المنتج، وضمان الجودة. يهدف التصميم الموضح هنا إلى تحقيق أعلى معايير الأمان، قابلية التوسع، الموثوقية، وسهولة الصيانة، مع التركيز على معالجة المخاطر المحتملة بشكل استباقي.

## 2. المبادئ المعمارية الأساسية

تم بناء هذه المعمارية على مجموعة من المبادئ الأساسية التي توجه جميع القرارات الهندسية:

*   **الأمان بالتصميم (Security-by-Design)**: يتم دمج الاعتبارات الأمنية في كل مرحلة من مراحل التصميم والتطوير، وليس كإضافة لاحقة. يتم التركيز على مبدأ الامتياز الأقل (Least Privilege) وعزل البيانات الصارم.
*   **قابلية التوسع (Scalability)**: تم تصميم النظام ليكون قابلاً للتوسع الأفقي، مما يسمح له بالنمو مع زيادة عدد المستأجرين وحجم البيانات دون تدهور في الأداء.
*   **الموثوقية والتوافرية العالية (Reliability & High Availability)**: يهدف التصميم إلى تقليل نقاط الفشل الفردية (Single Points of Failure) وضمان استمرارية الخدمة.
*   **سهولة الصيانة (Maintainability)**: يتم اعتماد بنية معيارية (Modular Architecture) وتقنيات حديثة لضمان سهولة فهم الكود، تحديثه، وتوسيع وظائفه المستقبلية.
*   **تجربة المستخدم (User Experience)**: يتم التركيز على توفير واجهات مستخدم بديهية وسريعة الاستجابة لجميع فئات المستخدمين.

## 3. حزمة التقنيات (Technology Stack)

تم اختيار حزمة التقنيات التالية لتحقيق المبادئ المعمارية المذكورة أعلاه:

| الفئة | التقنية | الإصدار المقترح | مبررات الاختيار |
|---|---|---|---|
| **الواجهة الأمامية** | Next.js (App Router) | 16.x+ | يوفر أداءً ممتازًا، تجربة مطورين رائعة، وقدرات SSR/SSG/ISR التي تعزز سرعة التحميل. |
| | React | 19.x+ | مكتبة رائدة لبناء واجهات المستخدم التفاعلية والمعيارية. |
| | TypeScript | 5.x+ | يفرض سلامة الأنواع (Type Safety)، مما يقلل من الأخطاء في وقت التشغيل ويحسن قابلية الصيانة. |
| | Tailwind CSS | 4.x+ | يسرّع عملية تصميم واجهات المستخدم من خلال نهج "utility-first". |
| **إدارة الحالة والبيانات** | React Query (TanStack) | 5.x+ | أفضل حل لإدارة بيانات الخادم، يوفر التخزين المؤقت، المزامنة التلقائية، وإعادة المحاولة. |
| | Zod + React Hook Form | - | يوفر نظامًا قويًا للتحقق من صحة النماذج من الواجهة الأمامية إلى الخلفية. |
| | Zustand | 4.x+ | حل بسيط وفعال لإدارة الحالة العامة على جانب العميل. |
| **الواجهة الخلفية** | Node.js | 20.x+ | بيئة تشغيل غير متزامنة (Asynchronous) وعالية الأداء، مثالية لتطبيقات الويب. |
| **قاعدة البيانات** | MongoDB | 7.x+ | قاعدة بيانات NoSQL مرنة وقابلة للتوسع أفقيًا، مناسبة تمامًا لنموذج البيانات الديناميكي. |
| | Mongoose | 8.x+ | يوفر طبقة من التجريد والتحقق من صحة المخطط (Schema Validation) فوق MongoDB. |
| **المصادقة والأمان** | JWT + HttpOnly Cookies | - | نهج آمن ومثبت لإدارة الجلسات في تطبيقات الويب الحديثة. |
| | Argon2 | - | خوارزمية تجزئة كلمات المرور (Password Hashing) حديثة وآمنة، موصى بها من قبل OWASP. |
| **تجربة المستخدم** | PWA (Progressive Web App) | - | يحسن تجربة المستخدم من خلال دعم العمل دون اتصال بالإنترنت وإمكانية التثبيت على الأجهزة. |

## 4. معمارية النظام التفصيلية

### 4.1. معمارية تعدد المستأجرين (Multi-Tenancy)

يعتمد النظام استراتيجية **`Shared Database, Shared Collection with Tenant ID`**. هذا يعني أن جميع بيانات الفنادق (المستأجرين) يتم تخزينها في قاعدة بيانات واحدة ومجموعات (Collections) مشتركة. يتم تحقيق عزل البيانات من خلال حقل `hotelId` إلزامي في كل مستند (Document) في قاعدة البيانات.

**آلية فرض العزل:**

1.  **على مستوى قاعدة البيانات**: يتم إنشاء فهارس مركبة (Compound Indexes) على `hotelId` مع الحقول الأخرى المستخدمة بشكل متكرر لضمان أداء الاستعلامات.
2.  **على مستوى التطبيق (ORM)**: يتم استخدام **Mongoose Middleware** (مثل `pre('find')`, `pre('findOne')`, `pre('updateMany')`) لحقن شرط `hotelId` تلقائيًا في جميع استعلامات القراءة والتحديث. هذا يقلل بشكل كبير من مخاطر الخطأ البشري الذي قد يؤدي إلى تسرب البيانات. [1]
3.  **على مستوى الـ API**: يتم التحقق من `hotelId` في كل طلب API لضمان أن المستخدم المصادق عليه يحاول الوصول إلى بيانات فندقه فقط.

### 4.2. المصادقة والتفويض (Authentication & Authorization)

*   **تدفق المصادقة**: يتم استخدام صفحة تسجيل دخول موحدة (`/login`). بعد التحقق من صحة بيانات الاعتماد (مع استخدام Argon2 لمقارنة تجزئة كلمة المرور)، يتم إنشاء JWT Access Token (قصير الأجل) و Refresh Token (طويل الأجل). يتم تخزين كلا الرمزين في `HttpOnly, Secure, SameSite=Strict Cookies`.
*   **التفويض (RBAC)**: يتم تعريف الأدوار والصلاحيات بشكل مركزي في `src/core/auth/roles.ts`. بعد المصادقة، يتم تحديد دور المستخدم وتوجيهه إلى الواجهة المناسبة. يتم التحقق من الصلاحيات في كل طلب API على الخادم باستخدام `hasPermission` decorator أو middleware.
*   **أمان السوبر أدمن**: يتم فرض **المصادقة متعددة العوامل (MFA)** بشكل إلزامي لجميع حسابات السوبر أدمن. يتم تسجيل جميع أنشطة السوبر أدمن في سجل تدقيق منفصل.

## 5. إدارة المخاطر ومعالجة المشكلات المتوقعة

هذا القسم يحدد المخاطر المحتملة ويصف استراتيجيات التخفيف منها لضمان استقرار وأمان النظام.

| الفئة | المشكلة المتوقعة (الخطر) | التأثير | استراتيجية المعالجة والتخفيف |
|---|---|---|---|
| **الأمان** | **تسرب البيانات بين المستأجرين**: خطأ برمجي في استعلام قاعدة البيانات يؤدي إلى عرض بيانات فندق لمستخدم من فندق آخر. | **مرتفع جدًا** | 1.  **فرض `hotelId` تلقائيًا**: استخدام Mongoose Middleware لحقن `hotelId` في جميع الاستعلامات.
2.  **مراجعات الكود الصارمة**: التركيز على مراجعة أي كود يتعامل مع الوصول إلى البيانات.
3.  **اختبارات التكامل**: كتابة اختبارات تكامل تتحقق من أن المستخدم لا يمكنه الوصول إلا لبياناته. |
| | **تصعيد الامتيازات (Privilege Escalation)**: مستخدم عادي يتمكن من الوصول إلى وظائف المدير أو السوبر أدمن. | **مرتفع جدًا** | 1.  **التحقق من الصلاحيات على الخادم**: يجب أن يتم التحقق من الصلاحيات دائمًا على الخادم (Backend) وليس فقط في الواجهة الأمامية.
2.  **نظام RBAC مركزي**: تعريف الصلاحيات بشكل واضح ومركزي.
3.  **اختبارات الاختراق**: إجراء اختبارات اختراق منتظمة لمحاكاة محاولات تصعيد الامتيازات. |
| **الأداء وقابلية التوسع** | **بطء الاستعلامات مع نمو البيانات**: مع زيادة عدد المستأجرين والبيانات، قد تصبح بعض الاستعلامات بطيئة. | **متوسط** | 1.  **فهرسة استباقية**: تحليل الاستعلامات الشائعة وإنشاء فهارس مناسبة في MongoDB.
2.  **مراقبة أداء قاعدة البيانات**: استخدام أدوات مثل MongoDB Atlas Performance Advisor لمراقبة الاستعلامات البطيئة.
3.  **التخزين المؤقت (Caching)**: استخدام Redis أو حلول تخزين مؤقت أخرى للبيانات التي يتم الوصول إليها بشكل متكرر. |
| | **فشل خدمة واحدة يؤثر على النظام بأكمله**: في بنية متجانسة (Monolith)، قد يؤدي فشل جزء من النظام إلى توقف الخدمة بالكامل. | **مرتفع** | 1.  **بنية معيارية**: على الرغم من أنها بنية متجانسة، إلا أن التصميم المعياري (Modular Design) يساعد في عزل الأخطاء.
2.  **إعادة التشغيل التلقائي (Health Checks)**: استخدام مديري العمليات (Process Managers) مثل PM2 أو Kubernetes لإجراء فحوصات صحية وإعادة تشغيل الحاويات الفاشلة تلقائيًا.
3.  **معالجة الأخطاء القوية**: استخدام كتل `try-catch` وآليات معالجة الأخطاء لمنع انهيار التطبيق. |
| **التشغيل والصيانة** | **صعوبة استعادة بيانات مستأجر واحد**: في حالة حدوث خطأ أو فقدان بيانات لمستأجر واحد، من الصعب استعادة بياناته فقط من نسخة احتياطية كاملة. | **متوسط** | 1.  **أدوات تصدير/استيراد مخصصة**: تطوير سكربتات مخصصة لتصدير واستيراد بيانات مستأجر واحد بناءً على `hotelId`.
2.  **النسخ الاحتياطي المستمر (Point-in-Time Recovery)**: استخدام خدمات مثل MongoDB Atlas التي توفر استعادة في نقطة زمنية محددة. |
| | **تحديثات المخطط (Schema Migrations)**: قد يكون تطبيق تغييرات على مخطط قاعدة البيانات مع وجود بيانات حية أمرًا معقدًا. | **منخفض** | 1.  **استخدام أدوات الترحيل**: استخدام أدوات ترحيل (Migration Tools) لإدارة تغييرات المخطط بشكل تدريجي وآمن.
2.  **التوافق مع الإصدارات السابقة**: تصميم التغييرات لتكون متوافقة مع الإصدارات السابقة قدر الإمكان. |

## 6. الوحدات الوظيفية والصلاحيات

(هذا القسم يظل كما هو مفصل في الوثيقة السابقة، مع التأكيد على أن جميع الوظائف تخضع لنظام RBAC الصارم.)

## 7. ملاحظات تنفيذية متقدمة

*   **المراقبة والتسجيل (Monitoring & Logging)**: يجب دمج نظام مراقبة وتسجيل مركزي (مثل **Datadog, New Relic, أو ELK Stack**) لجمع سجلات التطبيق، مراقبة الأداء، وإعداد تنبيهات استباقية للمشاكل المحتملة.
*   **الاختبارات الآلية (Automated Testing)**: يجب أن تكون الاختبارات الآلية جزءًا لا يتجزأ من عملية التطوير، مع خط أنابيب CI/CD يقوم بتشغيل الاختبارات تلقائيًا قبل أي عملية نشر.
*   **إدارة الإعدادات والأسرار (Configuration & Secrets Management)**: يجب تخزين جميع الإعدادات الحساسة (مثل مفاتيح API، كلمات مرور قاعدة البيانات) في خدمة إدارة أسرار آمنة (مثل **AWS Secrets Manager, HashiCorp Vault**) وعدم تخزينها في ملفات `.env` في بيئة الإنتاج.

## 8. خلاصة

هذه الوثيقة تمثل الأساس الهندسي لبناء نظام إدارة فنادق من الدرجة الأولى. من خلال الالتزام بالمبادئ، المعايير، واستراتيجيات التخفيف من المخاطر الموضحة هنا، يمكن لفريق التطوير بناء منتج ليس فقط يلبي المتطلبات الوظيفية، بل يتميز أيضًا بالأمان، الموثوقية، وقابلية التوسع على المدى الطويل.

## 9. المراجع

[1] Mongoose Middleware - [https://mongoosejs.com/docs/middleware.html](https://mongoosejs.com/docs/middleware.html)
